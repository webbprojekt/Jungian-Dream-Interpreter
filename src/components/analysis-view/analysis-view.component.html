<div class="max-w-6xl mx-auto p-4 md:p-8 bg-white dark:bg-gray-800 shadow-2xl rounded-lg my-8 print:shadow-none print:my-0 print:p-0">
  <!-- Header and Actions -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 print:hidden">
    <button (click)="back.emit()" class="flex items-center space-x-2 text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors mb-4 md:mb-0">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
      </svg>
      <span>Back to Journal</span>
    </button>
    <div class="flex items-center space-x-2">
      <button (click)="toggleReadAloud()" [title]="ttsService.isSpeaking() ? 'Stop Reading' : 'Read Aloud'" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        @if(ttsService.isSpeaking()) {
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9.563C9 9.252 9.252 9 9.563 9h4.874c.311 0 .563.252.563.563v4.874c0 .311-.252.563-.563.563H9.563A.562.562 0 0 1 9 14.437V9.564Z" />
          </svg>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
          </svg>
        }
      </button>
      <button (click)="exportToWord()" [disabled]="isExporting()" title="Export to Word (.docx)" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors disabled:opacity-50">
        @if (isExporting()) {
            <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
        }
      </button>
      <button (click)="printAnalysis()" title="Print" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0c1.281-.286 2.402-1.254 2.868-2.607A23.89 23.89 0 0 0 21 12c0-4.142-1.223-8.02-3.468-11.218a23.887 23.887 0 0 0-2.868-2.607C13.486.286 12.753 0 12 0s-1.486.286-2.868.775a23.89 23.89 0 0 0-2.868 2.607C3.223 3.98 2 7.858 2 12c0 1.707.291 3.328.825 4.812.466 1.353 1.587 2.321 2.868 2.607m0 0h11.318" />
        </svg>
      </button>
    </div>
  </div>

  <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
    <!-- Title -->
    <h1 class="font-serif text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-4">{{ entry().analysis.title }}</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">Analysis for dream on {{ entry().date | date:'fullDate' }}</p>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Image and Original Dream -->
      <div class="lg:col-span-1 space-y-8">
        <img [src]="entry().imageUrl" [alt]="entry().analysis.imagePrompt" class="w-full h-auto rounded-lg shadow-md object-cover aspect-square" />
        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
          <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-2">Your Dream</h3>
          <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed italic">"{{ entry().dreamText }}"</p>
        </div>
      </div>

      <!-- Right Column: Analysis and Interactive Elements -->
      <div class="lg:col-span-2">
        <div class="prose prose-lg dark:prose-invert max-w-none text-gray-700 dark:text-gray-300" [innerHTML]="formattedArticle()"></div>

        <!-- Chat CTA -->
        <div class="mt-8 text-center print:hidden">
            <button (click)="openChat.emit()" class="inline-flex items-center space-x-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105">
                <span>Chat with Your Dream</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.455.09-.934.09-1.425v-2.287a6.75 6.75 0 0 1 0-2.121M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </button>
        </div>

        <!-- Accordions -->
        <div class="mt-10 space-y-4">
          <!-- Jungian Concepts -->
          <div>
            <button (click)="toggleAccordion('jungian')" class="w-full flex justify-between items-center text-left p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
              <span class="font-bold text-xl text-gray-800 dark:text-white">Key Jungian Concepts</span>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500 dark:text-gray-400 transition-transform" [class]="activeAccordion() === 'jungian' ? 'rotate-180' : ''">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            @if(activeAccordion() === 'jungian') {
              <div class="p-4 border border-t-0 border-gray-200 dark:border-gray-600 rounded-b-lg space-y-4">
                @for(concept of entry().analysis.jungianConcepts; track concept.term) {
                  <div>
                    <h4 class="font-bold text-gray-900 dark:text-gray-100">{{ concept.term }}</h4>
                    <p class="text-gray-600 dark:text-gray-300">{{ concept.explanation }}</p>
                  </div>
                }
              </div>
            }
          </div>
          <!-- Mythological Connections -->
          <div>
            <button (click)="toggleAccordion('mythological')" class="w-full flex justify-between items-center text-left p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
              <span class="font-bold text-xl text-gray-800 dark:text-white">Mythological Parallels</span>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500 dark:text-gray-400 transition-transform" [class]="activeAccordion() === 'mythological' ? 'rotate-180' : ''">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            @if(activeAccordion() === 'mythological') {
              <div class="p-4 border border-t-0 border-gray-200 dark:border-gray-600 rounded-b-lg space-y-4">
                @for(connection of entry().analysis.mythologicalConnections; track connection.parallel) {
                  <div>
                    <h4 class="font-bold text-gray-900 dark:text-gray-100">{{ connection.parallel }}</h4>
                    <p class="text-gray-600 dark:text-gray-300">{{ connection.explanation }}</p>
                  </div>
                }
              </div>
            }
          </div>
        </div>

      </div>
    </div>
  </div>
</div>